---
id: two-way-payments
title: "2-Way Payments"
description: "Sending and receiving payments through A-Block.js is quick and simple"
sidebar_label: 2-Way Payments
sidebar_position: 2
hide_title: true
custom_edit_url: null
---

import ApiLogo from "@theme/ApiLogo";
import SchemaTabs from "@theme/SchemaTabs";
import TabItem from "@theme/TabItem";
import Export from "@theme/ApiDemoPanel/Export";

# 2-Way Payments

The problem in every blockchain (other than A-Block ðŸ˜‰) is that Alice pays Bob some coins, but the chain never records _why_. Put another way, there's no record of trade where Alice pays Bob 
for an item, and Bob sends Alice this item. Instead, payments on blockchain just look like charity, as though Alice felt sorry for Bob and decided to send him some coin for coffee (or maybe cocaine, the chain doesn't say). 
The closest you can currently get is to create a smart contract that encapsulates this logic, but those take far too long to write and are prone to risky 
and expensive bugs. 

**2-Way payments solve this problem.** Alice can send Bob `10` tokens, and Bob can send Alice `1` item, and both events are recorded on the A-Block chain with no smart contracts, no fuss!

..

## Send a Payment for an Item

2-Way transactions on A-Block are atomic, meaning that either both Alice and Bob get what they want, or the entire transaction is canceled. But they're also async, meaning that Alice and Bob don't need to be online 
at the same time in order for the transaction to go through. Let's test this as Alice, wanting to make a `10` token payment to Bob for `1` of his on-chain items

```javascript
import { initIAssetToken, initIAssetReceipt, ABlockWallet } from '@a-block/a-blockjs';

// ... wallet initialization set up

// The tokens we want to send
const tokensToSend = initIAssetToken({"Token": 10});

// The item we want to receive
const itemAliceWants = initIAssetReceipt({
  "Receipt": {
      "amount": 1,                // The amount of the item we want
      "drs_tx_hash": "a027...91b" // The genesis transaction hash for the item, its identifier on-chain
  }});

// Make the 2-way payment as Alice
const paymentResult = await wallet.makeRbPayment(
      bobAddress,       // Payment address
      tokensToSend,     // Payment asset
      itemAliceWants,   // Receiving asset
      allKeypairs,      // Alice's keypairs
      aliceAddress,     // Receive address
  );
```

This will complete Alice's side of the trade. **NOTE: Alice will need to initialize her wallet with a Valence node to connect to.** The Valence node is what allows this transaction to be asynchronous, because Bob will 
retrieve the transaction information from the Valence node before he can agree to the payment terms. This also means that Bob must be connected to the same Valence node in order to see the 2-way transaction from his side.

If Alice wants to save the response information from this 2-Way transaction, she can retrieve the DRUID and encrypted transaction values for storage as the result of the `makeRbPayment` call:

```javascript
const { druid, encryptedTx } = paymentResult.content.makeRbPaymentResponse;
```

The DRUID is the `string` value that Alice and Bob agree on so that their trades can be matched on the blockchain. It's generated by A-Block.js automatically, so you don't have to think about this too much, but this value 
can be absolutely anything. So long as both Alice and Bob use the same DRUID in their 2-Way transactions, the transactions will be matched by the chain successfully.

..

## Fetch Pending 2-Way Payments

If Bob is connected to the same Valence node as Alice, he can retrieve her pending 2-Way payment and see if he likes the terms of the trade or not:

```javascript
// Fetch pending 2-Way payments
const pendingRbTransactionsResult = await wallet.fetchPendingRbTransactions(
      allKeypairs,      // All of Bob's keypairs, which the function will pull addresses from
      allEncryptedTxs,  // Encrypted transactions, which are only required if they've been saved by Bob before
  );

const pendingRbTransactions = pendingRbTransactionsResult.content.fetchPendingRbResponse;
```

The result of this call might look something like the following:

```json
{
    "2a646...f8b98": {
        "timestamp": 1655117144145,
        "value": {
            "druid": "DRUID0xd0f407436f7f1fc494d7aee22939090e",
            "senderExpectation": {
                "from": "",
                "to": "2a646...f8b98",
                "asset": {
                    "Receipt": {
                        "amount": 1,
                        "drs_tx_hash": "a027...91b"
                    }
                }
            },
            "receiverExpectation": {
                "from": "295b2...8d4fa",
                "to": "18f70...caeda",
                "asset": {
                    "Token": 25200
                }
            },
            "status": "pending",
            "computeHost": "http://127.0.0.1:3003"
        }
    }
}
```

Here we can see all kinds of information about the proposed 2-Way payment, including the DRUID, the item or asset that Alice expects in return from Bob, and the status of the transaction (in this case, `"pending"`). 

If Bob has the item that Alice wants, he now has 2 options: he can either **accept the terms**, in which case the transaction will be executed, or **reject them**, in which case nothing happens and Alice and Bob both keep their 
respective assets.

..

## Accepting and Rejecting 2-Way Payments

A-Block.js provides built-in ways to accept and reject 2-Way payments, assuming that both parties are coordinating off the same Valence node. 

```javascript
const druid = 'DRUID0xd0f407436f7f1fc494d7aee22939090e';    // DRUID value that matches Alice and Bob's transactions
const pendingRbTransactions = pendingRbTransactionsResult   // The response we received from fetching pending 2-Way payments
    .content
    .fetchPendingRbResponse;   

// Accept a 2-Way payment using its unique `DRUID` identifier
await wallet.acceptRbTx(druid, pendingRbTransactions, allKeypairs);

//-- --------------------------------- OR ---------------------------------- --//

// Reject a 2-Way payment using its unique `DRUID` identifier
await wallet.rejectRbTx(druid, pendingRbTransactions, allKeypairs);
```

Once called, A-Block.js will automatically send the right response to the Valence node, and the entire 2-Way transaction can be executed on the A-Block chain if accepted. Once executed on-chain, 
both Alice and Bob will see the balances of their respective assets updated to reflect the trade.

..